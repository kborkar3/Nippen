package com.projectwork.action.graph;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.sql.Timestamp;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.GregorianCalendar;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import javax.servlet.http.HttpServletRequest;

import org.apache.log4j.Logger;
import org.apache.struts2.interceptor.ServletRequestAware;
import org.jfree.chart.ChartFactory;
import org.jfree.chart.ChartUtilities;
import org.jfree.chart.JFreeChart;
import org.jfree.chart.plot.PlotOrientation;
import org.jfree.data.category.DefaultCategoryDataset;
import org.jfree.data.time.Day;
import org.jfree.data.time.Hour;
import org.jfree.data.time.TimeSeries;
import org.jfree.data.time.TimeSeriesCollection;

import com.opensymphony.xwork2.ActionSupport;
import com.projectwork.bean.DataTableBean;
import com.projectwork.bean.FeederBean;
import com.projectwork.constants.TestProjectConstantsIfc;
import com.projectwork.impl.GraphServiceImpl;
import com.projectwork.impl.LoginServiceImpl;

public class DisplayGraphAction extends ActionSupport implements TestProjectConstantsIfc, ServletRequestAware
{
    private HttpServletRequest request;

    private String feeder;

    private String startDate;

    private String endDate;

    private List<FeederBean> feederList = new ArrayList<FeederBean>();

    private static Logger logger = Logger.getLogger(DisplayGraphAction.class);

    /**
     * Graph is generated and displayed based on search criteria.
     * 
     * @param
     * @return success: Graph DTO retrieved and displayed on screen
     * @return error: No records found for entered search criteria.
     * @throws Exception
     */

    public String execute() throws Exception
    {

        /*
         * JQuery UI is in dd/MM/yyyy format. So first parse and format input
         * string to the format.
         */

        SimpleDateFormat formatter = new SimpleDateFormat("dd/MM/yyyy");
        formatter.setLenient(false);
        Date sdate = (Date)formatter.parse(startDate);
        Date edate = (Date)formatter.parse(endDate);
        startDate = formatter.format(sdate);
        endDate = formatter.format(edate);

        /* Now covert dates in dd/MM/yyyy format to dd-MMM-yy format used by db */

        SimpleDateFormat newformatter = new SimpleDateFormat(DATE_FORMAT);
        newformatter.setLenient(false);
        startDate = newformatter.format(sdate);
        endDate = newformatter.format(edate);

        java.util.Date usd = new java.text.SimpleDateFormat(DATE_FORMAT).parse(startDate);
        java.util.Date ued = new java.text.SimpleDateFormat(DATE_FORMAT).parse(endDate);
        java.sql.Date sqlStartDate = new java.sql.Date(usd.getTime());
        java.sql.Date sqlEndDate = new java.sql.Date(ued.getTime());

        GraphServiceImpl graphServiceObject = new GraphServiceImpl();
        List<DataTableBean> graphList = graphServiceObject.getGraphData(feeder, sqlStartDate, sqlEndDate);

        /*
         * Get all dates between start date and end date and store it in
         * 'datesInRangeList' for future if all the dates in between also to be
         * shown.
         */

        List<String> datesInRangeList = getDaysBetweenDates(sdate, edate);

        // Alkesh
        ArrayList<DataTableBean> graphParametersList = graphServiceObject.getGraphParameterData(feeder, sqlStartDate,
                sqlEndDate);
        
        
        if (!(graphParametersList.isEmpty()))
        {
            Collections.sort(graphParametersList, new Comparator<DataTableBean>()
            {
                public int compare(DataTableBean m1, DataTableBean m2)
                {
                    return m1.getDateTimeStamp().compareTo(m2.getDateTimeStamp());
                }
            });

            // Get Parameter Names from indexes
            int graphParametersListSize = graphParametersList.size();
            String parameterName = null;
            
            
            LoginServiceImpl loginObject = new LoginServiceImpl();
            for (int i = 0; i < graphParametersListSize; i++)
            {
                parameterName = loginObject.getParameterName(graphParametersList.get(i).getParameterIndex());
                graphParametersList.get(i).setParameterName(parameterName);
            }

            String fullpath = request.getRealPath("") + "//" + "newLine.png";
            File file = new File(fullpath);
            FileOutputStream out = new FileOutputStream(file);
            JFreeChart chart = null;
            
            if(sqlStartDate.equals(sqlEndDate))
            {
                chart  = createDayChart(graphParametersList);
            }
            else
            {
                chart = createChart(graphParametersList);
            }
            
            try
            {
                ChartUtilities.writeChartAsPNG(out, chart, 900, 400);
                out.flush();
                out.close();
            }
            catch (IOException ioEx)
            {
                System.err.println("Error writing PNG file ");
            }
            return RETURN_SUCCESS;
        } // ALkesh

        else
        {
            request.getSession().setAttribute("nographdatafound", "nographdatafound");
            
            return "redirect";
        }

    }
    
    public JFreeChart createDayChart(ArrayList<DataTableBean> graphParametersList)
    {

        ArrayList<DataTableBean> newGraphParametersList = (ArrayList)graphParametersList.clone();

        Date sdate = null;

        TimeSeriesCollection dataset = new TimeSeriesCollection();

        TimeSeries[] newTimer = new TimeSeries[newGraphParametersList.size()];

        Set<String> newGraphParametersSet = new HashSet<String>();

        for (int i = 0; i < newGraphParametersList.size(); i++)
        {
            boolean isAdded = false;

            String currentParam = newGraphParametersList.get(i).getParameterName();

            newTimer[i] = new TimeSeries(currentParam);

            newGraphParametersSet.add(currentParam);

            for (int j = 0; j < graphParametersList.size(); j++)
            {
                if (currentParam.equals(graphParametersList.get(j).getParameterName()))
                {
                    sdate = graphParametersList.get(j).getDateTimeStamp().getTime();
                    
                    System.out.println(currentParam + "\t" + sdate + "\t" + graphParametersList.get(j).getValue());

                    newTimer[i].addOrUpdate(new Hour(sdate), graphParametersList.get(j).getValue());

                    graphParametersList.remove(j);
                    j--;

                    isAdded = true;
                }
            }

            if (isAdded)
            {
                dataset.addSeries(newTimer[i]);
            }

        }

        JFreeChart chart = ChartFactory.createTimeSeriesChart("Parameter Data", "Time", "Parameter Value", dataset,
                true, true, false);

        return chart;
    }
    

    public JFreeChart createChart(ArrayList<DataTableBean> graphParametersList)
    {

        ArrayList<DataTableBean> newGraphParametersList = (ArrayList)graphParametersList.clone();

        Date sdate = null;

        TimeSeriesCollection dataset = new TimeSeriesCollection();

        TimeSeries[] newTimer = new TimeSeries[newGraphParametersList.size()];

        Set<String> newGraphParametersSet = new HashSet<String>();

        for (int i = 0; i < newGraphParametersList.size(); i++)
        {
            boolean isAdded = false;

            String currentParam = newGraphParametersList.get(i).getParameterName();

            newTimer[i] = new TimeSeries(currentParam);

            newGraphParametersSet.add(currentParam);

            for (int j = 0; j < graphParametersList.size(); j++)
            {
                if (currentParam.equals(graphParametersList.get(j).getParameterName()))
                {
                    sdate = graphParametersList.get(j).getDateTimeStamp().getTime();

                    newTimer[i].addOrUpdate(new Day(sdate), graphParametersList.get(j).getValue());

                    graphParametersList.remove(j);
                    j--;

                    isAdded = true;
                }
            }

            if (isAdded)
            {
                dataset.addSeries(newTimer[i]);
            }

        }

        JFreeChart chart = ChartFactory.createTimeSeriesChart("Parameter Data", "Date", "Parameter Value", dataset,
                true, true, false);

        return chart;
    }

    /**
     * This method will generate line chart
     * 
     * @param graphParametersList
     * @return line chart
     */

    public static JFreeChart generateLineChart(List<DataTableBean> graphParametersList)
    {
        DefaultCategoryDataset dataSet = new DefaultCategoryDataset();

        SimpleDateFormat newformatter = new SimpleDateFormat(DATE_FORMAT);
        newformatter.setLenient(false);
        for (int i = 0; i < graphParametersList.size(); i++)
        {
            dataSet.setValue(graphParametersList.get(i).getValue(), "Reading",
                    newformatter.format(toDate(graphParametersList.get(i).getDateTimeStamp())));
        }

        JFreeChart chart = ChartFactory.createLineChart("Meter Reading", "Date", "Reading", dataSet,
                PlotOrientation.VERTICAL, false, true, false);

        return chart;
    }

    /**
     * This method will get all dates between start date and end date selected
     * by the user from search page
     * 
     * @param : start date and end date
     * @return : List of all dates between start date and end date
     */

    public static List<String> getDaysBetweenDates(Date sdate, Date edate)
    {
        List<String> dates = new ArrayList<String>();
        Calendar calendar = new GregorianCalendar();
        calendar.setTime(sdate);

        SimpleDateFormat newformatter = new SimpleDateFormat(DATE_FORMAT);
        newformatter.setLenient(false);

        while (calendar.getTime().before(edate))
        {
            Date result = calendar.getTime();
            dates.add(newformatter.format(result));
            calendar.add(Calendar.DATE, 1);
        }
        return dates;
    }

    /**
     * This method will convert calendar date to java date
     * 
     * @param : timestamp
     * @return : date in java.util.date format
     */

    public static java.util.Date toDate(Calendar cal)
    {

        Timestamp timestamp = null;
        if (cal != null)
        {
            timestamp = new Timestamp(cal.getTimeInMillis());
        }

        long milliseconds = timestamp.getTime() + (timestamp.getNanos() / 1000000);
        return new java.util.Date(milliseconds);
    }

    /**
     * This method checks for null value
     * 
     * @param : String
     * @return true: String is null
     * @return false: String is not null
     */

    protected boolean isEmpty(String value)
    {
        if (value == null || value.trim().equals(""))
        {
            return true;
        }
        return false;
    }

    public void setServletRequest(HttpServletRequest httpServletRequest)
    {
        this.request = httpServletRequest;
    }

    public String getFeeder()
    {
        return feeder;
    }

    public void setFeeder(String feeder)
    {
        this.feeder = feeder;
    }

    public String getStartDate()
    {
        return startDate;
    }

    public void setStartDate(String startDate)
    {
        this.startDate = startDate;
    }

    public String getEndDate()
    {
        return endDate;
    }

    public void setEndDate(String endDate)
    {
        this.endDate = endDate;
    }

    public List<FeederBean> getFeederList()
    {
        return feederList;
    }

    public void setFeederList(List<FeederBean> feederList)
    {
        this.feederList = feederList;
    }
}