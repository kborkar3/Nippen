package com.projectwork.action.historicalreport;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.InputStream;
import java.util.Calendar;
import java.util.List;

import javax.servlet.http.HttpServletRequest;

import net.sf.dynamicreports.jasper.builder.JasperReportBuilder;
import net.sf.dynamicreports.report.exception.DRException;

import org.apache.log4j.Logger;
import org.apache.struts2.interceptor.ServletRequestAware;

import com.opensymphony.xwork2.ActionSupport;
import com.projectwork.constants.TestProjectConstantsIfc;
import com.projectwork.dto.HistoricReportDTO;
import com.projectwork.impl.HistoricReportServiceImpl;



public class ExportReportAction extends ActionSupport implements TestProjectConstantsIfc, ServletRequestAware
{
    private HttpServletRequest request;

    private InputStream fileInputStream;
    
    private String fileName;

    private static Logger logger = Logger.getLogger(ExportReportAction.class);

    /**
     * Exports displayed report in pdf format
     * 
     * @return success: Report successfully exported
     * @return error: No records found for entered search criteria.
     * @throws Exception
     */

    
    public String execute() throws Exception
    {
        List<HistoricReportDTO> historicalReportdtoList = null;
        historicalReportdtoList = (List<HistoricReportDTO>)request.getSession().getAttribute("historicalReportdtoList");
        JasperReportBuilder report = null;

        if (!(historicalReportdtoList == null))
        {
            HistoricReportServiceImpl historicReportServiceObject = new HistoricReportServiceImpl();
            report = historicReportServiceObject.exportHistoricalReport(historicalReportdtoList);

            if (report != null)
            {
                try
                {
                    java.util.Date date = new java.util.Date();

                    Calendar calendar = Calendar.getInstance();
                    calendar.setTime(date);
                    long currentTime = calendar.getTimeInMillis();
                    String currentTimeStamp = Long.toString(currentTime);
                    
                    String testFileName = "historyReport" + currentTimeStamp + ".pdf";
                    String histReportPath = request.getRealPath("") + "//" + testFileName;
                    /*String histReportPath = request.getRealPath("") + "//" + "historyReport.pdf";*/
                    report.toPdf(new FileOutputStream(histReportPath));
                    fileInputStream = new FileInputStream(new File(histReportPath));
                    
                    fileName = new File(histReportPath).getName();
                    
                    request.setAttribute("historyReportPath", histReportPath);
                }
                catch (DRException e)
                {
                    logger.error("DRException occurred");
                }
                catch (FileNotFoundException e)
                {
                    logger.error("FileNotFoundException occurred");
                }

                return RETURN_SUCCESS;
            }

            else
            {
                return RETURN_ERROR;
            }
        }
        else
        {
            return RETURN_ERROR;
        }
    }

    public void setServletRequest(HttpServletRequest httpServletRequest)
    {
        this.request = httpServletRequest;
    }

    public InputStream getFileInputStream()
    {
        return fileInputStream;
    }

    public String getFileName()
    {
        return fileName;
    }

    public void setFileName(String fileName)
    {
        this.fileName = fileName;
    }

}
